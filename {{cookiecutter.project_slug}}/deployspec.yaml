publishGenericEnvVariables: true
deploy:
  phases:
    install:
      commands:
        - TERRAFORM_VERSION=1.12.2
        - wget https://releases.hashicorp.com/terraform/"$TERRAFORM_VERSION"/terraform_"$TERRAFORM_VERSION"_linux_amd64.zip
        - unzip terraform_"$TERRAFORM_VERSION"_linux_amd64.zip
        - mv terraform /usr/local/bin/
    pre_build:
      commands:
      - echo "Prebuild stage"
    build:
      commands:
       - terraform init -input=false
       - terraform plan -input=false -out tf.plan
       - terraform apply -auto-approve
       - terraform output -json > ./tf-exports.json
    post_build:
      commands:
      - echo "Deploy successful"
destroy:
  phases:
    install:
      commands:
        - TERRAFORM_VERSION=1.12.2
        - wget https://releases.hashicorp.com/terraform/"$TERRAFORM_VERSION"/terraform_"$TERRAFORM_VERSION"_linux_amd64.zip
        - unzip terraform_"$TERRAFORM_VERSION"_linux_amd64.zip
        - mv terraform /usr/local/bin/
    pre_build:
      commands:
      - echo "Prebuild stage"
    build:
      commands:
      - terraform init
      - terraform destroy -auto-approve
    post_build:
      commands:
      - echo "Destroy successful"
build_type: BUILD_GENERAL1_SMALL